---
- name: Copy environment variables file
  template:
    src: env.j2
    dest: "{{ express_app_path }}/.env"
    mode: 0644
    owner: "{{ express_system_user }}"
    group: "{{ express_system_group }}"
  tags:
    - molecule-idempotence-notest
  changed_when: false # noqa 301

- name: Install Javascript requirements
  become: true
  become_user: "{{ express_system_user }}"
  yarn:
    state: present
    path: "{{ item }}"
  with_items: "{{ express_package_json_paths }}"
  tags:
    - molecule-idempotence-notest

- name: Compile Javascript
  command:
    cmd: yarn build
    chdir: "{{ express_app_path }}"
  become: true
  become_user: "{{ express_system_user }}"
  tags:
    - molecule-idempotence-notest # noqa 301

# creates a sym-link express_codebase_path; that points to the express checkout path
- name: Make the new codebase current
  file:
    src: "{{ express_checkout_path }}"
    dest: "{{ express_codebase_path }}"
    state: link
    force: true
    owner: "{{ express_system_user }}"
    group: "{{ express_system_group }}"
  tags:
    - molecule-idempotence-notest

- name: pm2 configure
  include_role:
    name: weareinteractive.pm2
  vars:
    pm2_cmds:
      - run: "delete {{ pm2_express_service_name }}"
        ignore_errors: true
    pm2_post_cmds:
      - run: save
      - run: kill
    pm2_apps:
      - run: dist/index.js
        cmd: start
        args: --name "{{ pm2_express_service_name }}"
        path: "{{ express_checkout_path }}"
    pm2_user: "{{ express_system_user }}"
    pm2_service_name: "pm2-{{ pm2_user }}"
    tags:
    - molecule-idempotence-notest # noqa 301
